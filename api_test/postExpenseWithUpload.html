<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>GAS ExpenseWithUpload Test</title>
</head>
<body>

<h2>ExpenseWithUpload (base64, optional image)</h2>

<div>
  <label>Date (YYYY-MM-DD):</label>
  <input type="text" id="date" value="2026-01-03">
</div>

<div>
  <label>Amount:</label>
  <input type="number" id="amount" step="0.01" value="1201.00">
</div>

<div>
  <label>Category:</label>
  <select id="category">
    <option value="dining_out">dining_out</option>
    <option value="groceries" selected>groceries</option>
  </select>
</div>

<div>
  <label>Receipt image (optional):</label>
  <input type="file" id="file" accept="image/*">
</div>

<button type="button" onclick="send()">Send expense_with_upload</button>

<pre id="preview"></pre>

<script>
function send() {
  const date = document.getElementById("date").value.trim();
  const amount = Number(document.getElementById("amount").value);
  const category = document.getElementById("category").value;
  const file = document.getElementById("file").files[0];

  // 共通payload（画像なしでも送れる）
  const payload = {
    action: "expense_with_upload",
    date,
    amount,
    category
  };

  const submitPayload = (finalPayload) => {
    // 見やすいプレビュー（改行付き）
    document.getElementById("preview").textContent = JSON.stringify(finalPayload, null, 2);

    // form POST（送信は1行JSON）
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://script.google.com/macros/s/AKfycbxdq4fcooY1RC-BH8v4Nw7NgoXiNSwp1DotEv2U2eqFmkGI2L9ZCH0FoXWAamVPt_Hm/exec";

    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "payload";
    input.value = JSON.stringify(finalPayload);

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  };

  // 画像が無いならそのまま送信（uploadはGAS側でskipped扱いにできる）
  if (!file) {
    submitPayload(payload);
    return;
  }

  // 画像がある場合：base64化して同じpayloadに詰める
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = String(reader.result).split(",")[1]; // data:...;base64, を除去
    submitPayload({
      ...payload,
      mime_type: file.type || "image/jpeg",
      base64
    });
  };
  reader.onerror = () => {
    // 画像読み取り失敗でも expense は送れるようにする（画像無しで送信）
    submitPayload(payload);
  };

  reader.readAsDataURL(file);
}
</script>

</body>
</html>
